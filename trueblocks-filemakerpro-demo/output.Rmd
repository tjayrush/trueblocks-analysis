---
params:
  filepath: "."
  address: "0xfb6916095ca1df60bb79ce92ce3ea74c37c5d359"
  name: "Aragon Dream DAO Party"
always_allow_html: yes
output:
  html_document:
    theme: sandstone
    df_print: paged
    includes:
    code_folding: "hide"
    css: "style.css"
---

<div class="header">
<img src="trueblocks-logo.png" class="logo"/>
<h1>Autogenerated R output</h1>
<ul>
<li><strong>Address:</strong> `r params$address`</li>
<li><strong>Name:</strong> `r params$name`</li>
<li><strong>Date:</strong> `r Sys.Date()`</li>
</ul>
</div>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(scales)
```

```{r message=FALSE, echo=FALSE, warning=FALSE}
data.set <- read_csv(params$filepath) %>%
  mutate(Date = as.POSIXct(Date, format="%m/%d/%Y %H:%M:%S")) %>%
#  mutate(FunctionName = ifelse(is.na(FunctionName), "NA", FunctionName)) %>%
  mutate(FromName = ifelse(is.na(FromName), From, FromName)) %>%
  mutate(isError = isError == 1) %>%
  return()

theme_set(theme_minimal(base_size=12))
```


# ETH Amounts

<div class="blue">
This section deals with the ether coming in and out of the account.
</div>

## ETH deposit timeline

```{r message=FALSE, fig.height=4}
data.set %>%
  filter(To == params$address) %>%
  ggplot(aes(x=BlockNumber, y=NA, size=EtherValue, color=isError)) +
  scale_color_manual(values = c("#000000","#CC0000")) +
  geom_jitter()
```

## Top value transferred in by account

```{r message=FALSE}
data.set %>%
  filter(To == params$address) %>%
  group_by(FromName) %>%
  summarize(n = n(), sum.eth.value = sum(EtherValue)) %>%
  arrange(desc(sum.eth.value)) %>%
  mutate(sum.eth.value = round(sum.eth.value, 3))
```

## Chart of ETH in/out
```{r message=FALSE, warning=FALSE, fig.align='center', fig.height=4, fig.width=4, fig.cap="This chart is a work in progress. In the case of smart contracts, it is common for 'ETH out' values to be contained in traces. We still have to parse these traces to include them in this chart."}
data.set %>%
  mutate(Type = ifelse(To == params$address, "In", ifelse(From == params$address, "From", "Other"))) %>%
  filter(Type %in% c("In", "Out")) %>%
  mutate(Date = as.Date(Date)) %>%
  mutate(EtherValue = ifelse(Type == "Out", -EtherValue, EtherValue)) %>%
  group_by(Type, Date) %>%
  summarize(val = sum(EtherValue)) %>%
  mutate(cumval = cumsum(val)) %>%
  ggplot(aes(x=Date, y=cumval, color=Type)) +
  geom_line() +
  labs(title="Ether In/Out", y="Cumulative Ether In/Out")
```

# Function calls

## 

```{r message=FALSE, fig.align='center', fig.height=8}
data.set %>%
  filter(To == params$address) %>%
  ggplot(aes(x=BlockNumber, fill=isError)) +
  geom_histogram() +
  scale_x_continuous(labels = comma) +
  labs(title = paste0("Functions called on address ", params$address)) + 
  facet_wrap(facets = "FunctionName", ncol = 1) +
  scale_fill_manual(values = c("#000000","#CC0000"))
```


##  Activity plot for top 10 most active users (users ranked by appearance count)

```{r message=FALSE, echo=FALSE}
top10 <- data.set %>%
  filter(To == params$address) %>%
  group_by(FromName) %>%
  summarize(count = n()) %>%
  top_n(10, count) %>%
  filter(row_number() <= 10) %>%
  select(FromName) %>%
  unlist() %>%
  unname()
```

```{r message=FALSE, fig.align='center', fig.width=10, fig.height=12}
data.set %>%
  filter(To == params$address) %>%
  filter(FromName %in% top10) %>%
  ggplot(aes(x=Date, y=FunctionName, color=isError)) +
  scale_fill_manual(values = c("#000000","#CC0000")) +
  geom_jitter(width=.2, height=.2) +
  facet_wrap(facets = 'FromName', ncol=1) +
  theme(legend.position="none") +
  labs(title = paste0("Function timeline for top 10 users"))
```

```{r}
params
```